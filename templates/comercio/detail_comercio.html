{% extends 'base.html' %}
{% load leaflet_tags %}
{% load static %}
{% load ratings %}
{% load comments %}
{% load to_point %}
import string

{% block content %}
     {% if object %}
        <div class="row">
            <div class="col s1"></div>
            <div class="section white col s10">
                <h1>{{ comercio.nombre }}</h1>
                <div class="col s6"><img src="{{comercio.imagen.url}}" ></div>
                <div class="row">
                    <div class="col s10 offset-s1">
                      <ul class="tabs">
                        <li class="tab col s3"><a class="active" href="#test1">Informacion General</a></li>
                        <li class="tab col s3"><a href="#test2">Menu</a></li>
                        {% get_comment_count for comercio.comercio comercio.pk as comment_count %}
                        <li class="tab col s3"><a href="#test3">Opiniones ({{ comment_count }})</a></li>
                      </ul>

                    <!-- Tab Informacion -->
                    <div id="test1" class="col s12">
                        <table class="striped">
                            <tbody>
                              <tr>
                                <td><h5>Horarios:</h5></td>
                                <td><i>{{ comercio.horarios }}</i></td>
                              </tr>
                              <tr>
                                <td><h5>Rubro:</h5></td>
                                <td>
                                    <ul>
                                        {% for r in comercio.rubro.all %}
                                            <li>{{ r }}</li>
                                        {% endfor %}
                                    </ul>
                                </td>
                              </tr>
                              <tr>
                                <td><h5>Domicilio:</h5></td>
                                <td><i>{{ comercio.domicilio }}</i></td>
                              </tr>
                              <tr>
                                <td><h5>Telefono:</h5></td>
                                <td><i>{{ comercio.telefono.tipo }} - {{ comercio.telefono.descripcion }}</i></td>
                              </tr>
                              <tr>
                                <td><h5>Formas de Pago:</h5></td>
                                <td><i>{{ comercio.forma_pago }}</i></td>
                              </tr>
                              <tr>
                                <td><h5>Delivery:</h5></td>
                                <td><i>{{ comercio.delivery }}</i></td>
                              </tr>
                              <tr>
                                <td><h5>Descripcion:</h5></td>
                                <td><i>{{ comercio.descripcion }}</i></td>
                              </tr>
                            </tbody>
                          </table>

                        <h5>Ubicacion</h5><br>
                        <input type="text" id="mode" value="DRIVING" hidden>
                        <div id="map" style="height:60%"></div><br></br>
                            <script>
                        var pos1;
                        function initMap() {
                          var directionsDisplay = new google.maps.DirectionsRenderer;
                          var directionsService = new google.maps.DirectionsService;

                          var map = new google.maps.Map(document.getElementById('map'), {
                            zoom: 14,
                            center: {lat: 37.77, lng: -122.447}
                          });

                          directionsDisplay.setMap(map);



                          // Try HTML5 geolocation.
                          var infoWindow = new google.maps.InfoWindow({map: map});

                          if (navigator.geolocation) {
                            navigator.geolocation.getCurrentPosition(function(position) {
                              var pos = {lat: position.coords.latitude, lng: position.coords.longitude};
                              pos1 = pos;
                              infoWindow.setPosition(pos);
                              infoWindow.setContent('Usted esta Aqui');
                              map.setCenter(pos);
                              calculateAndDisplayRoute(directionsService, directionsDisplay, pos1);
                            }, function() {
                              handleLocationError(true, infoWindow, map.getCenter());
                            });
                          } else {
                            // Browser doesn't support Geolocation
                            handleLocationError(false, infoWindow, map.getCenter());
                          }
                          document.getElementById('mode').addEventListener('change', function() {
                              calculateAndDisplayRoute(directionsService, directionsDisplay, pos1);
                          });
                        }

                        function calculateAndDisplayRoute(directionsService, directionsDisplay, pos) {
                          pos1 = pos;
                          //alert(JSON.stringify(pos1));
                          // NO LLEGA alert(pos1);
                          var selectedMode = document.getElementById('mode').value;

                          directionsService.route({
                            //origin: {lat: -28.476784, lng: -65.783980},
                            origin: pos1,
                            destination: {lat: {{comercio.latitud|to_point}}, lng: {{comercio.longitud|to_point}}},
                            travelMode: google.maps.TravelMode['DRIVING']
                          }, function(response, status) {
                            if (status == google.maps.DirectionsStatus.OK) {
                              directionsDisplay.setDirections(response);
                            } else {
                              window.alert('Directions request failed due to ' + status);
                            }
                          });
                        }

                        function handleLocationError(browserHasGeolocation, infoWindow) {
                          infoWindow.setPosition(pos);
                          infoWindow.setContent(browserHasGeolocation ?
                                                'Error: The Geolocation service failed.' :
                                                'Error: Your browser doesn\'t support geolocation.');
                        }

                            </script>
                            <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBHpVXm1_SpgpAUOMwQ-c9PC-dtnklO3n0&callback=initMap"  async defer></script>

                    </div>
                    <!-- Fin Tab Informacion -->

                    <!-- Tab Menu -->
                    <div id="test2" class="col s12">

                          <div class="row">
                                <div class="col s12 m12">
                                      <div class="card small">
                                            <div class="card-image">
                                                <img src="{% static 'img/banners/Carnes.png'%}">
                                                <span class="card-title">Carnes</span>
                                            </div>

                                            <div class="card-content">
                                            </div>
                                      </div>
                                </div>
                          </div>
                          <div class="row">
                                <div class="col s12 m12">
                                      <div class="card small">
                                            <div class="card-image">
                                                <img src="{% static 'img/banners/Sandwichs.png'%}">
                                                <span class="card-title">Pastas</span>
                                            </div>
                                            <div class="card-content">
                                                <p>ACA VA LA COMIDA QUE SEA DE RUBRO PASTAS</p>
                                            </div>
                                      </div>
                                </div>
                          </div>
                          <div class="row">
                                <div class="col s12 m12">
                                      <div class="card small">
                                            <div class="card-image">
                                                <img src="{% static 'img/banners/Tragos.png'%}">
                                                <span class="card-title">Tragos</span>
                                            </div>
                                            <div class="card-content">
                                                <p>ACA VA LA COMIDA QUE SEA DE RUBRO TRAGOS</p>
                                            </div>
                                      </div>
                                </div>
                          </div>
                    </div>
                    <!-- Fin Tab Menu -->

                     <!-- Tab Opiniones -->
                     <div id="test3" class="col s12">
                     <!-- Ratings -->
                    <h4>Puntaje {{comercio.nombre}}:</h4>
                    <link rel="stylesheet" href="{% static 'star-ratings/css/star-ratings.css' %}">
                    <script type="text/javascript" src="{% static 'star-ratings/js/dist/star-ratings.min.js' %}"></script>
                    {% ratings object %}
                    <!-- Fin Ratings -->
                       <h4>Opiniones:</h4>
                       {% get_comment_list for comercio.comercio comercio.pk as comment_list %}
                        {% for comment in comment_list %}
                        <div class="col s12 m12">
                            <div class="card-panel grey lighten-5 z-depth-1">
                              <div class="row valign-wrapper">
                                <div class="col s2">
                                  <img class="circle responsive-img" src="{{ user.socialaccount_set.all.0.get_avatar_url }}" style="width: 100%"/>
                                </div>
                                <div class="col s10">
                                  <span class="black-text">
                                    <p>{{ comment.user_name }}</p>
                                    <p> el {{ comment.submit_date }}</p>
                                      <div class="divider"></div>
                                    <p>{{ comment.comment }}</p>
                                  </span>
                                </div>
                              </div>
                          </div>
                        {% endfor %}
                            <div class="row"><br>
                                <div class="col s8 offset-s2">
                                <!-- Aca se Muestra el formulario para enviar un comentario -->
                                    {% render_comment_form for comercio %}
                                <!-- Fin formulario para enviar un comentario -->
                                </div>
                            </div>
                        </div>
                      </div>
                      <!-- Fin Tab Opiniones -->

                    </div>
                  </div>
              </div>
            </div>
        </div>
    {% else %}
         <h1>No se encontro el Comercio</h1>
    {% endif %}
{% endblock %}